<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Developer WebSocket Console (/dev)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 20px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    main {
      flex: 1;
      padding: 16px 20px 20px;
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr) minmax(0, 1fr);
      grid-gap: 16px;
    }
    .panel {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.7);
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
    }
    label {
      font-size: 12px;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
    }
    .field-row {
      margin-bottom: 8px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      transition: background 0.15s ease, transform 0.05s ease, border-color 0.15s;
    }
    button.primary {
      background: #2563eb;
      border-color: #3b82f6;
    }
    button.danger {
      background: #b91c1c;
      border-color: #ef4444;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    button:hover:not(:disabled) {
      transform: translateY(-0.5px);
      filter: brightness(1.05);
    }
    #status {
      font-size: 12px;
      margin-top: 4px;
      color: #9ca3af;
    }
    #status span {
      font-weight: 500;
    }
    #status span.ok {
      color: #4ade80;
    }
    #status span.err {
      color: #f97316;
    }
    #log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #020617;
      border-radius: 4px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      height: calc(100vh - 170px);
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #camera-view {
      background: #020617;
      border-radius: 4px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      height: calc(100vh - 170px);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    #camera-view img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
      cursor: pointer;
      user-select: none;
    }
    #camera-view img:hover {
      opacity: 0.9;
    }
    #camera-view .placeholder {
      color: #6b7280;
      font-size: 12px;
      text-align: center;
    }
    #camera-view .fullscreen-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid #374151;
      border-radius: 4px;
      padding: 6px 10px;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      z-index: 10;
      display: none;
    }
    #camera-view:hover .fullscreen-btn {
      display: block;
    }
    #camera-view .fullscreen-btn:hover {
      background: rgba(0, 0, 0, 0.8);
      border-color: #3b82f6;
    }
    #camera-view:fullscreen {
      background: #000;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #camera-view:fullscreen img {
      max-width: 100vw;
      max-height: 100vh;
    }
    #camera-view:fullscreen .fullscreen-btn {
      display: block;
      top: 20px;
      right: 20px;
      font-size: 14px;
      padding: 8px 14px;
    }
    .log-line {
      margin: 0;
    }
    .log-line.in {
      color: #a5b4fc;
    }
    .log-line.out {
      color: #6ee7b7;
    }
    .log-line.sys {
      color: #9ca3af;
    }
    footer {
      padding: 6px 20px 10px;
      font-size: 11px;
      color: #6b7280;
      border-top: 1px solid #1f2937;
      background: #020617;
    }
  </style>
</head>
<body>
  <header>
    <h1>Developer WebSocket Console <span style="color:#6b7280;">(/dev)</span></h1>
    <div id="status">状态: <span class="err">未连接</span></div>
  </header>
  <main>
    <section class="panel">
      <h2>连接配置</h2>
      <div class="field-row">
        <label for="ws-url">WebSocket URL</label>
        <input id="ws-url" type="text" />
    </div>
      <div class="btn-row">
        <button id="btn-connect" class="primary">连接</button>
        <button id="btn-disconnect">断开</button>
  </div>

      <h2 style="margin-top:12px;">命令控制</h2>
      <p style="font-size:11px;color:#9ca3af;margin:0 0 6px;">向后端 <code>/dev</code> 连接发送命令，配合 Arduino 摄像头客户端使用。</p>
      
      <div class="field-row">
        <label for="resolution">分辨率</label>
        <select id="resolution" style="width:100%;padding:6px 8px;border-radius:4px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:12px;box-sizing:border-box;">
          <option value="FHD">FHD (1920×1080)</option>
          <option value="HD" selected>HD (1280×720)</option>
          <option value="QSXGA">QSXGA (2560×1920) - OV3660不支持</option>
          <option value="QXGA">QXGA (2048×1536)</option>
          <option value="UXGA">UXGA (1600×1200)</option>
          <option value="SXGA">SXGA (1280×1024)</option>
          <option value="XGA">XGA (1024×768)</option>
          <option value="SVGA">SVGA (800×600)</option>
          <option value="VGA">VGA (640×480)</option>
          <option value="P_3MP">P_3MP (864×1536)</option>
          <option value="P_HD">P_HD (720×1280)</option>
        </select>
      </div>
      
      <div class="field-row">
        <label for="quality">JPEG质量 (1-63，越小质量越高)</label>
        <input id="quality" type="number" min="1" max="63" placeholder="默认: 12" style="width:100%;padding:6px 8px;border-radius:4px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:12px;box-sizing:border-box;" />
      </div>
      
      <div class="btn-row">
        <button id="btn-start">start</button>
        <button id="btn-stop">stop</button>
        <button id="btn-status">status</button>
      </div>
      <div class="field-row" style="margin-top:10px;">
        <label for="custom-cmd">自定义命令</label>
        <input id="custom-cmd" type="text" placeholder="例如：status 或 任意调试字符串" />
      </div>
      <div class="btn-row">
        <button id="btn-send-custom">发送自定义命令</button>
    </div>
    </section>

    <section class="panel">
      <h2>日志</h2>
      <div id="log"></div>
    </section>

    <section class="panel">
      <h2>摄像头画面</h2>
      <div id="camera-view">
        <div class="placeholder">等待图片数据...</div>
        <button class="fullscreen-btn" id="fullscreen-btn" title="全屏 (F11或双击图片)">全屏</button>
  </div>
    </section>
  </main>
  <footer>
    提示：默认 URL 为 <code>ws://pqzc1405495.bohrium.tech:50001/dev</code>，如需连接其它服务器可手动修改。
  </footer>

  <script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const urlInput = document.getElementById('ws-url');
    const btnConnect = document.getElementById('btn-connect');
    const btnDisconnect = document.getElementById('btn-disconnect');
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    const btnStatus = document.getElementById('btn-status');
    const resolutionSelect = document.getElementById('resolution');
    const qualityInput = document.getElementById('quality');
    const customCmdInput = document.getElementById('custom-cmd');
    const btnSendCustom = document.getElementById('btn-send-custom');
    const cameraView = document.getElementById('camera-view');
    const fullscreenBtn = document.getElementById('fullscreen-btn');

    let ws = null;

    function defaultWsUrl() {
      // 后端固定部署在 pqzc1405495.bohrium.tech:50001/dev
      return 'ws://pqzc1405495.bohrium.tech:50001/dev';
    }

    function setStatus(text, ok) {
      const span = statusEl.querySelector('span') || document.createElement('span');
      span.textContent = text;
      span.className = ok ? 'ok' : 'err';
      statusEl.innerHTML = '状态: ';
      statusEl.appendChild(span);
    }

    function appendLog(type, text) {
      const p = document.createElement('div');
      p.className = `log-line ${type}`;
      const now = new Date().toLocaleTimeString();
      p.textContent = `[${now}] ${text}`;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateButtons() {
      const connected = ws && ws.readyState === WebSocket.OPEN;
      btnConnect.disabled = connected;
      btnDisconnect.disabled = !connected;
      btnStart.disabled = !connected;
      btnStop.disabled = !connected;
      btnStatus.disabled = !connected;
      btnSendCustom.disabled = !connected;
    }

    function connect() {
      const url = urlInput.value.trim() || defaultWsUrl();
      urlInput.value = url;

      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
        appendLog('sys', '已有连接正在使用，不重复连接。');
        return;
      }

      appendLog('sys', `尝试连接到 ${url} ...`);
      setStatus('连接中...', false);

      ws = new WebSocket(url);

      ws.onopen = () => {
        appendLog('sys', 'WebSocket 已连接。');
        setStatus('已连接', true);
        updateButtons();
      };

      ws.onclose = (event) => {
        appendLog('sys', `WebSocket 连接已关闭 (code=${event.code}, reason=${event.reason || '无'})`);
        setStatus('未连接', false);
        updateButtons();
      };

      ws.onerror = (err) => {
        appendLog('sys', 'WebSocket 发生错误（详情见控制台）。');
        console.error('WebSocket error:', err);
        setStatus('错误', false);
      };

      ws.onmessage = (event) => {
        const data = event.data;
        
        // 检查是否为二进制数据（图片）
        if (data instanceof Blob || data instanceof ArrayBuffer) {
          // 处理二进制图片数据
          const blob = data instanceof Blob ? data : new Blob([data], { type: 'image/jpeg' });
          const reader = new FileReader();
          
          reader.onload = (e) => {
            // 清除占位符
            const placeholder = cameraView.querySelector('.placeholder');
            if (placeholder) {
              placeholder.remove();
    }

            // 创建新图片元素
            const newImg = document.createElement('img');
            newImg.style.display = 'none'; // 先隐藏，等待加载完成
            
            // 添加双击进入全屏功能
            newImg.addEventListener('dblclick', toggleFullscreen);
            
            // 等待新图片加载完成后再显示
            const showNewImage = () => {
              // 获取当前显示的图片
              const oldImg = cameraView.querySelector('img');
              
              // 将新图片添加到DOM（如果还没有）
              if (!newImg.parentNode) {
                cameraView.appendChild(newImg);
              }
              
              // 显示新图片
              newImg.style.display = 'block';
              
              // 立即移除旧图片（双缓冲机制确保无缝切换）
              if (oldImg && oldImg !== newImg) {
                oldImg.remove();
              }
            };
            
            // 图片加载完成事件
            newImg.onload = showNewImage;
            
            // 图片加载错误事件
            newImg.onerror = () => {
              appendLog('sys', '图片加载失败');
              if (newImg.parentNode) {
                newImg.remove();
              }
            };
            
            // 设置图片源（这会触发onload）
            newImg.src = e.target.result;
            
            // 如果图片已经加载完成（缓存），立即显示
            if (newImg.complete && newImg.naturalWidth > 0) {
              showNewImage();
            }
          };
          
          reader.onerror = () => {
            appendLog('sys', '图片数据读取失败');
          };
          
          reader.readAsDataURL(blob);
        } else {
          // 处理文本消息（日志）
          appendLog('in', `← ${data}`);
        }
      };

      updateButtons();
    }

    function disconnect() {
      if (ws) {
        appendLog('sys', '手动关闭连接...');
        ws.close();
        ws = null;
        updateButtons();
      }
    }

    function sendCommand(cmd) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        appendLog('sys', '尚未连接，无法发送命令。');
        return;
      }
      cmd = cmd.trim();
      if (!cmd) return;
      ws.send(cmd);
      appendLog('out', `→ ${cmd}`);
    }

    // 全屏功能
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        // 进入全屏
        if (cameraView.requestFullscreen) {
          cameraView.requestFullscreen();
        } else if (cameraView.webkitRequestFullscreen) {
          cameraView.webkitRequestFullscreen();
        } else if (cameraView.msRequestFullscreen) {
          cameraView.msRequestFullscreen();
        }
          } else {
        // 退出全屏
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }

    function updateFullscreenButton() {
      if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
        fullscreenBtn.textContent = '退出全屏';
      } else {
        fullscreenBtn.textContent = '全屏';
          }
    }

    // 监听全屏状态变化
    document.addEventListener('fullscreenchange', updateFullscreenButton);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
    document.addEventListener('msfullscreenchange', updateFullscreenButton);

    // 全屏按钮点击事件
    fullscreenBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleFullscreen();
    });

    // 键盘快捷键：F11进入/退出全屏，ESC退出全屏
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F11') {
        e.preventDefault();
        toggleFullscreen();
      } else if (e.key === 'Escape' && (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement)) {
        toggleFullscreen();
      }
    });

    // 初始化
    urlInput.value = defaultWsUrl();
    updateButtons();

    btnConnect.addEventListener('click', connect);
    btnDisconnect.addEventListener('click', disconnect);
    btnStart.addEventListener('click', () => {
      // 读取分辨率和质量参数
      const resolution = resolutionSelect.value.trim();
      const quality = qualityInput.value.trim();
      
      // 构造命令
      let cmd = 'start';
      if (resolution || quality) {
        const parts = [];
        if (resolution) {
          parts.push(resolution);
        }
        if (quality) {
          parts.push(quality);
        }
        if (parts.length > 0) {
          cmd = 'start ' + parts.join(' ');
        }
      }
      
      sendCommand(cmd);
    });
    btnStop.addEventListener('click', () => sendCommand('stop'));
    btnStatus.addEventListener('click', () => sendCommand('status'));
    btnSendCustom.addEventListener('click', () => sendCommand(customCmdInput.value));

    customCmdInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        sendCommand(customCmdInput.value);
      }
    });
  </script>
</body>
</html>


