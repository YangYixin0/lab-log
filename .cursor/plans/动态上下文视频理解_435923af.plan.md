---
name: 动态上下文视频理解
overview: 重构视频理解模块，将固定提示词改为动态上下文驱动：基于当天事件缓存、人物外貌表缓存和二维码识别结果构建提示，模型输出续写事件和外貌更新。事件立即入库，外貌表缓存在内存/文件。
todos:
  - id: appearance-cache
    content: 创建 context/appearance_cache.py：并查集、AppearanceCache 类
    status: completed
  - id: event-context
    content: 创建 context/event_context.py：查询当天最新 n 条事件
    status: completed
  - id: prompt-builder
    content: 创建 context/prompt_builder.py：动态提示词构建器
    status: completed
  - id: refactor-processor
    content: 重构 qwen3_vl_processor.py：使用动态上下文和新解析逻辑
    status: completed
  - id: update-models
    content: 更新 storage/models.py：新增 AppearanceRecord，调整 EventLog 字段
    status: completed
  - id: simplify-writer
    content: 简化 log_writer/writer.py：移除加密，适配新字段
    status: completed
  - id: integrate-server
    content: 集成到 streaming_server/server.py：传递缓存、周期性 dump
    status: completed
  - id: eod-skeleton
    content: 创建 scripts/end_of_day.py 骨架：日终处理预留接口
    status: completed
---

