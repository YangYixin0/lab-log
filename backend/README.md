# WebSocket MJPEG 服务器

## 功能说明

此Python WebSocket服务器：
- 监听 `0.0.0.0:50001` 端口
- 支持两个 endpoint：
  - `/esp` - Arduino摄像头客户端连接
  - `/dev` - 开发者前端控制台连接
- 接收Arduino发送的摄像头MJPEG数据（JPEG二进制）
- 保存图片到 `images/` 目录
- 文件名格式：`frame_YYYYMMDD_HHMMSS_XXX.jpg`
- 最多保存200张图片，超出后自动删除最旧的
- 每秒统计并打印FPS（帧率）
- 支持通过终端命令行控制Arduino开始/停止采集
- 支持前端通过WebSocket发送命令，后端自动转发给Arduino
- Arduino的日志会实时发送给前端显示

## 安装依赖

```bash
pip install -r requirements.txt
```

## 运行服务器

```bash
python server.py
```

服务器启动后会：
- 显示监听地址和配置信息
- 显示支持的 endpoint
- 等待客户端连接（Arduino 或前端）
- 接收并保存摄像头帧
- 每秒打印FPS统计信息

## 输出示例

```
[14:30:25] [服务器] 启动WebSocket服务器...
[14:30:25] [服务器] 监听地址: 0.0.0.0:50001
[14:30:25] [服务器] 图片保存路径: /path/to/backend/images
[14:30:25] [服务器] 最多保存图片数: 200
[14:30:25] [服务器] 支持的endpoint:
[14:30:25] [服务器]   /esp - Arduino摄像头客户端
[14:30:25] [服务器]   /dev - 开发者前端控制台
[14:30:25] [服务器] 等待客户端连接...
------------------------------------------------------------
[14:30:30] [Arduino] 新连接: 192.168.1.100:54321
[14:30:30] [服务器] 可以使用以下命令控制采集:
  start  - 开始采集
  stop   - 停止采集
  status - 查询状态
  help   - 显示帮助
[14:30:31] [Arduino] FPS: 2.50 (总帧数: 3)
[14:30:32] [Arduino] FPS: 2.30 (总帧数: 8)
[14:30:35] [前端] 新连接: 192.168.1.101:54322
...
```

## 日志格式说明

所有日志都包含客户端类型标识：
- `[Arduino]` - Arduino客户端相关日志
- `[前端]` - 前端控制台相关日志
- `[终端]` - 终端命令相关日志
- `[服务器]` - 服务器系统日志

时间格式为 `HH:MM:SS`（只显示时分秒）。

## 图片存储

- **存储路径**：`backend/images/`
- **文件命名**：`frame_YYYYMMDD_HHMMSS_XXX.jpg`
  - `YYYYMMDD`：日期
  - `HHMMSS`：时间
  - `XXX`：帧序号（3位数字）
- **存储限制**：最多200张，超出后自动删除最旧的图片

## 控制命令

### 终端命令

服务器启动后，可以在终端输入以下命令控制Arduino：

- `start` - 开始采集和上传摄像头数据
- `stop` - 停止采集和上传
- `status` - 查询Arduino当前状态（采集中/已停止）
- `help` - 显示帮助信息
- `quit` 或 `exit` - 退出程序

### 前端命令

前端可以通过WebSocket连接到 `/dev` endpoint，发送以下命令：
- `start` - 开始采集
- `stop` - 停止采集
- `status` - 查询状态
- 其他任意文本（作为调试信息）

前端发送的命令会被后端自动转发给Arduino，Arduino的响应和日志会实时发送回前端显示。

### 使用示例

**终端命令示例：**

```
[14:30:30] [Arduino] 新连接: 192.168.1.100:54321
[14:30:30] [服务器] 可以使用以下命令控制采集:
  start  - 开始采集
  stop   - 停止采集
  status - 查询状态
  help   - 显示帮助

start
[14:30:35] [终端] 已发送命令: start
[14:30:35] [Arduino] ACK: 开始采集
[14:30:36] [Arduino] FPS: 2.50 (总帧数: 3)
[14:30:37] [Arduino] FPS: 2.30 (总帧数: 8)

stop
[14:30:40] [终端] 已发送命令: stop
[14:30:40] [Arduino] ACK: 停止采集
```

**前端命令示例：**

```
[14:30:35] [前端] 新连接: 192.168.1.101:54322
[14:30:40] [服务器] 收到命令: start
[14:30:40] [服务器] 已转发命令给Arduino: start
[14:30:40] [Arduino] ACK: 开始采集
[14:30:41] [Arduino] FPS: 2.50 (总帧数: 3)
```

## WebSocket Endpoint

### `/esp` - Arduino摄像头客户端

- Arduino通过此endpoint连接
- 发送JPEG二进制数据（摄像头帧）
- 接收文本命令（start/stop/status）
- 发送文本响应（ACK/STATUS）

### `/dev` - 开发者前端控制台

- 前端通过此endpoint连接
- 发送文本命令（start/stop/status等）
- 接收Arduino的日志和响应
- 命令会被自动转发给Arduino

## 停止服务器

按 `Ctrl+C` 或输入 `quit` 停止服务器。停止时会显示总共接收的帧数。
